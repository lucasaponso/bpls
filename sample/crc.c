#include <stdio.h>
#include <stdio.h>
#include <stdint.h>
#include <stdbool.h>

#define CHECKSUM 0xF0B8

static void crc16(uint8_t ch, uint16_t *crc);
static uint16_t slipcrc(uint8_t *buf, int nbuf);
int validate_crc(uint8_t * output_buffer, int len);


int main(int argc, char const *argv[])
{
    uint8_t hex_data[] = {
        0x7c, 0x56, 0x00, 0x00, 0x42, 0x08, 0x01, 0x30, 0x32, 0x34, 0x37, 0x00, 0x32, 0x31, 0x38, 0x39,
        0x33, 0x43, 0x00, 0x30, 0x00, 0x30, 0x00, 0x30, 0x2e, 0x30, 0x30, 0x00, 0x31, 0x31, 0x2f, 0x30, 
        0x35, 0x2f, 0x32, 0x30, 0x32, 0x34, 0x20, 0x30, 0x35, 0x3a, 0x31, 0x37, 0x3a, 0x33, 0x36, 0x20, 
        0x50, 0x4d, 0x00, 0x4d, 0x69, 0x6e, 0x65, 0x72, 0x61, 0x69, 0x00, 0x4c, 0x41, 0x56, 0x4f, 0x49, 
        0x45, 0x2c, 0x20, 0x44, 0x41, 0x4e, 0x49, 0x45, 0x4c, 0x00, 0x30, 0x2e, 0x30, 0x30, 0x00, 0x30, 
        0x2e, 0x30, 0x30, 0x00, 0x30, 0x2e, 0x30, 0x30, 0x00, 0x87, 0xbe
        }; //91 bytes

    // //The hex data to be sent periodically
    // uint8_t hex_data[] = {
    //     0x7c, 0x67, 0x00, 0x00, 0x01, 0x08, 0x01, 0x54, 0x31, 0x35, 0x31, 0x00, 0x31, 0x33, 0x31, 0x46,
    //     0x6c, 0x65, 0x65, 0x74, 0x20, 0x31, 0x00, 0x34, 0x39, 0x2e, 0x31, 0x38, 0x35, 0x38, 0x38, 0x00,
    //     0x2d, 0x31, 0x32, 0x33, 0x2e, 0x31, 0x30, 0x36, 0x31, 0x35, 0x00, 0x2d, 0x31, 0x37, 0x32, 0x00,
    //     0x31, 0x30, 0x2f, 0x31, 0x36, 0x2f, 0x32, 0x30, 0x31, 0x32, 0x20, 0x30, 0x36, 0x3a, 0x34, 0x32,
    //     0x3a, 0x32, 0x33, 0x50, 0x4d, 0x00, 0x4d, 0x30, 0x31, 0x00, 0x46, 0x69, 0x6e, 0x63, 0x68, 0x2c,
    //     0x20, 0x4a, 0x61, 0x63, 0x6b, 0x00, 0x31, 0x30, 0x35, 0x32, 0x2e, 0x30, 0x32, 0x00, 0x36, 0x36,
    //     0x35, 0x33, 0x2e, 0x31, 0x32, 0x00, 0x31, 0x30, 0x33, 0x2e, 0x35, 0x30, 0x00, 0x41, 0x47
    // };

    // uint8_t hex_data[] = {
    //   0x7c, 0x0c, 0x00, 0x00, 0x01, 0x08, 0x02, 0x54, 0x31, 0x35, 0x31, 0x00, 0x31, 0x34, 0x35, 0xb7, 0x4f
    // };

    int len = sizeof(hex_data);

    if (validate_crc(hex_data, len) == 0) //check msg crc
    {
        printf("VALIDATED\n");
        return 0;
    }

    return 1;    
}



int validate_crc(uint8_t * output_buffer, int len)
{
    uint16_t * p;
    p = (uint16_t *)&output_buffer[len - 2];
    printf("CRC = %04x\n", *p);

    printf("Length: %d\n", len);
    uint16_t crc = slipcrc(output_buffer, len - 2);
    printf("CRC = %04x\n", crc);
    
    if (crc == *p)
    {
        return 0;
    }
    else
    {
        printf("NO");
        return 1;
    }
    
    
}

static uint16_t slipcrc(uint8_t *buf, int nbuf)
{
    static uint8_t crcbuf[2];
    uint16_t crc = 0;
    while( --nbuf >= 0 )
        crc16(*buf++, &crc);
    crc = ~crc;
    crcbuf[0] = (crc) & 255;
    crcbuf[1] = (crc >> 8) & 255;
    printf("%02x %02x\n", crcbuf[0], crcbuf[1]);
    return crc;
}

static void crc16(uint8_t ch, uint16_t *crc)
{
    uint8_t bits = 8;
    uint16_t c = *crc;
    do
    {
        if( (ch & 1) ^ (c & 1) )
        {
            c >>= 1;
            c ^= 0x8408;
        }
        else
        {
            c >>= 1;
        }

        ch >>= 1;
    } while( --bits );
    *crc = c;
}
